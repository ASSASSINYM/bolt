<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Interpreter__Runtime_env (interpreter.Interpreter__Runtime_env)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc %%VERSION%%"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../index.html">interpreter</a> &#x00BB; Interpreter__Runtime_env</nav><h1>Module <code>Interpreter__Runtime_env</code></h1><p>This module defines the runtime environment of the interpreter, from the instructions and values to the definition of stacks, heaps and threads. It also contains a list of helper functions to manipulate the said types defined here.</p></header><aside><p>Abstract data types for thread ID and heap address</p></aside><dl><dt class="spec type" id="type-threadID"><a href="#type-threadID" class="anchor"></a><code><span class="keyword">type</span> threadID</code></dt><dt class="spec type" id="type-address"><a href="#type-address" class="anchor"></a><code><span class="keyword">type</span> address</code></dt></dl><aside><p>Helper functions to compare and print to string</p></aside><dl><dt class="spec value" id="val-string_of_address"><a href="#val-string_of_address" class="anchor"></a><code><span class="keyword">val</span> string_of_address : <a href="index.html#type-address">address</a> <span>&#45;&gt;</span> string</code></dt><dt class="spec value" id="val-string_of_thread_id"><a href="#val-string_of_thread_id" class="anchor"></a><code><span class="keyword">val</span> string_of_thread_id : <a href="index.html#type-threadID">threadID</a> <span>&#45;&gt;</span> string</code></dt><dt class="spec value" id="val-compare_thread_ids"><a href="#val-compare_thread_ids" class="anchor"></a><code><span class="keyword">val</span> compare_thread_ids : <a href="index.html#type-threadID">threadID</a> <span>&#45;&gt;</span> <a href="index.html#type-threadID">threadID</a> <span>&#45;&gt;</span> int</code></dt><dt class="spec value" id="val-compare_addresses"><a href="#val-compare_addresses" class="anchor"></a><code><span class="keyword">val</span> compare_addresses : <a href="index.html#type-address">address</a> <span>&#45;&gt;</span> <a href="index.html#type-address">address</a> <span>&#45;&gt;</span> int</code></dt></dl><dl><dt class="spec type" id="type-value"><a href="#type-value" class="anchor"></a><code><span class="keyword">type</span> value</code><code> = </code><table class="variant"><tr id="type-value.NULL" class="anchored"><td class="def constructor"><a href="#type-value.NULL" class="anchor"></a><code>| </code><code><span class="constructor">NULL</span></code></td></tr><tr id="type-value.REF" class="anchored"><td class="def constructor"><a href="#type-value.REF" class="anchor"></a><code>| </code><code><span class="constructor">REF</span> <span class="keyword">of</span> <a href="index.html#type-address">address</a></code></td><td class="doc"><p>An reference is an address in the heap</p></td></tr><tr id="type-value.INT" class="anchored"><td class="def constructor"><a href="#type-value.INT" class="anchor"></a><code>| </code><code><span class="constructor">INT</span> <span class="keyword">of</span> int</code></td></tr><tr id="type-value.CLOSURE" class="anchored"><td class="def constructor"><a href="#type-value.CLOSURE" class="anchor"></a><code>| </code><code><span class="constructor">CLOSURE</span> <span class="keyword">of</span> <a href="index.html#type-bytecode">bytecode</a> * <a href="index.html#type-env">env</a></code></td></tr><tr id="type-value.THREAD_ID" class="anchored"><td class="def constructor"><a href="#type-value.THREAD_ID" class="anchor"></a><code>| </code><code><span class="constructor">THREAD_ID</span> <span class="keyword">of</span> <a href="index.html#type-threadID">threadID</a></code></td><td class="doc"><p>this final value type is placed as a marker on the stack to determine the thread that the current thread is waiting on</p></td></tr></table></dt><dd><p>Values are irreducible expressions - these are stored on the stack along with any environment bindings.</p></dd></dl><dl><dt class="spec type" id="type-instruction"><a href="#type-instruction" class="anchor"></a><code><span class="keyword">and</span> instruction</code><code> = </code><table class="variant"><tr id="type-instruction.PUSH" class="anchored"><td class="def constructor"><a href="#type-instruction.PUSH" class="anchor"></a><code>| </code><code><span class="constructor">PUSH</span> <span class="keyword">of</span> <a href="index.html#type-value">value</a></code></td></tr><tr id="type-instruction.BIND" class="anchored"><td class="def constructor"><a href="#type-instruction.BIND" class="anchor"></a><code>| </code><code><span class="constructor">BIND</span> <span class="keyword">of</span> <a href="../../ast/Ast/Ast_types/Var_name/index.html#type-t">Ast.Ast_types.Var_name.t</a></code></td><td class="doc"><p>expects the set value to be on top of the stack. Creates a new binding on stack</p></td></tr><tr id="type-instruction.BLOCKED" class="anchored"><td class="def constructor"><a href="#type-instruction.BLOCKED" class="anchor"></a><code>| </code><code><span class="constructor">BLOCKED</span></code></td></tr><tr id="type-instruction.MK_CLOSURE" class="anchored"><td class="def constructor"><a href="#type-instruction.MK_CLOSURE" class="anchor"></a><code>| </code><code><span class="constructor">MK_CLOSURE</span> <span class="keyword">of</span> <a href="index.html#type-bytecode">bytecode</a></code></td><td class="doc"><p>pushes a closure onto the stack</p></td></tr><tr id="type-instruction.STACK_LOOKUP" class="anchored"><td class="def constructor"><a href="#type-instruction.STACK_LOOKUP" class="anchor"></a><code>| </code><code><span class="constructor">STACK_LOOKUP</span> <span class="keyword">of</span> <a href="../../ast/Ast/Ast_types/Var_name/index.html#type-t">Ast.Ast_types.Var_name.t</a></code></td></tr><tr id="type-instruction.STACK_SET" class="anchored"><td class="def constructor"><a href="#type-instruction.STACK_SET" class="anchor"></a><code>| </code><code><span class="constructor">STACK_SET</span> <span class="keyword">of</span> <a href="../../ast/Ast/Ast_types/Var_name/index.html#type-t">Ast.Ast_types.Var_name.t</a></code></td><td class="doc"><p>expects the set value to be on top of the stack. Also note - this updates the most recent binding for the variable, unlike BIND which adds a new binding</p></td></tr><tr id="type-instruction.HEAP_FIELD_LOOKUP" class="anchored"><td class="def constructor"><a href="#type-instruction.HEAP_FIELD_LOOKUP" class="anchor"></a><code>| </code><code><span class="constructor">HEAP_FIELD_LOOKUP</span> <span class="keyword">of</span> <a href="../../ast/Ast/Ast_types/Field_name/index.html#type-t">Ast.Ast_types.Field_name.t</a></code></td><td class="doc"><p>note this expects the object's Addr on top of the stack</p></td></tr><tr id="type-instruction.HEAP_FIELD_SET" class="anchored"><td class="def constructor"><a href="#type-instruction.HEAP_FIELD_SET" class="anchor"></a><code>| </code><code><span class="constructor">HEAP_FIELD_SET</span> <span class="keyword">of</span> <a href="../../ast/Ast/Ast_types/Field_name/index.html#type-t">Ast.Ast_types.Field_name.t</a></code></td><td class="doc"><p>note this expects <code>Addr, Value</code> as top two elements of the stack</p></td></tr><tr id="type-instruction.SWAP" class="anchored"><td class="def constructor"><a href="#type-instruction.SWAP" class="anchor"></a><code>| </code><code><span class="constructor">SWAP</span></code></td><td class="doc"><p>Swaps the top two elements on the stack</p></td></tr><tr id="type-instruction.POP" class="anchored"><td class="def constructor"><a href="#type-instruction.POP" class="anchor"></a><code>| </code><code><span class="constructor">POP</span></code></td></tr><tr id="type-instruction.APPLY" class="anchored"><td class="def constructor"><a href="#type-instruction.APPLY" class="anchor"></a><code>| </code><code><span class="constructor">APPLY</span></code></td><td class="doc"><p>function application - takes top two elements of stack (value, closure) in that order and applies value to a closure</p></td></tr><tr id="type-instruction.CONSTRUCTOR" class="anchored"><td class="def constructor"><a href="#type-instruction.CONSTRUCTOR" class="anchor"></a><code>| </code><code><span class="constructor">CONSTRUCTOR</span> <span class="keyword">of</span> <a href="../../ast/Ast/Ast_types/Class_name/index.html#type-t">Ast.Ast_types.Class_name.t</a></code></td><td class="doc"><p>Creates a new object on the stack</p></td></tr><tr id="type-instruction.SPAWN" class="anchored"><td class="def constructor"><a href="#type-instruction.SPAWN" class="anchor"></a><code>| </code><code><span class="constructor">SPAWN</span> <span class="keyword">of</span> <a href="index.html#type-bytecode">bytecode</a></code></td><td class="doc"><p>This spawns a new thread with the given instruction list</p></td></tr></table></dt><dt class="spec type" id="type-bytecode"><a href="#type-bytecode" class="anchor"></a><code><span class="keyword">and</span> bytecode</code><code> = <span><a href="index.html#type-instruction">instruction</a> list</span></code></dt><dt class="spec type" id="type-binding"><a href="#type-binding" class="anchor"></a><code><span class="keyword">and</span> binding</code><code> = <a href="../../ast/Ast/Ast_types/Var_name/index.html#type-t">Ast.Ast_types.Var_name.t</a> * <a href="index.html#type-value">value</a></code></dt><dd><p>Bytecode is used interchangeably when referring to a list of instructions</p></dd></dl><dl><dt class="spec type" id="type-env"><a href="#type-env" class="anchor"></a><code><span class="keyword">and</span> env</code><code> = <span><a href="index.html#type-binding">binding</a> list</span></code></dt><dd><p>An environment binds variables to values</p></dd></dl><dl><dt class="spec type" id="type-env_or_value"><a href="#type-env_or_value" class="anchor"></a><code><span class="keyword">type</span> env_or_value</code><code> = </code><table class="variant"><tr id="type-env_or_value.Env" class="anchored"><td class="def constructor"><a href="#type-env_or_value.Env" class="anchor"></a><code>| </code><code><span class="constructor">Env</span> <span class="keyword">of</span> <a href="index.html#type-env">env</a></code></td></tr><tr id="type-env_or_value.V" class="anchored"><td class="def constructor"><a href="#type-env_or_value.V" class="anchor"></a><code>| </code><code><span class="constructor">V</span> <span class="keyword">of</span> <a href="index.html#type-value">value</a></code></td></tr></table></dt><dt class="spec type" id="type-stack"><a href="#type-stack" class="anchor"></a><code><span class="keyword">type</span> stack</code><code> = <span><a href="index.html#type-env_or_value">env_or_value</a> list</span></code></dt></dl><aside><p>We can push both values and environments on the stack</p></aside><dl><dt class="spec type" id="type-obj"><a href="#type-obj" class="anchor"></a><code><span class="keyword">type</span> obj</code><code> = </code><code>{</code><table class="record"><tr id="type-obj.class_name" class="anchored"><td class="def field"><a href="#type-obj.class_name" class="anchor"></a><code>class_name : <a href="../../ast/Ast/Ast_types/Class_name/index.html#type-t">Ast.Ast_types.Class_name.t</a>;</code></td></tr><tr id="type-obj.fields" class="anchored"><td class="def field"><a href="#type-obj.fields" class="anchor"></a><code><span class="keyword">mutable</span> fields : <span><span>(<a href="../../ast/Ast/Ast_types/Field_name/index.html#type-t">Ast.Ast_types.Field_name.t</a> * <a href="index.html#type-value">value</a>)</span> list</span>;</code></td></tr></table><code>}</code></dt></dl><aside><p>Note we tag each object with its class name (could be used in future if subtyping introduced into language)</p></aside><dl><dt class="spec type" id="type-heap"><a href="#type-heap" class="anchor"></a><code><span class="keyword">type</span> heap</code><code> = <span><span>(<a href="index.html#type-address">address</a> * <a href="index.html#type-obj">obj</a>)</span> list</span></code></dt><dd><p>A heap maps addresses to objects</p></dd></dl><dl><dt class="spec type" id="type-thread"><a href="#type-thread" class="anchor"></a><code><span class="keyword">type</span> thread</code><code> = </code><table class="variant"><tr id="type-thread.TThread" class="anchored"><td class="def constructor"><a href="#type-thread.TThread" class="anchor"></a><code>| </code><code><span class="constructor">TThread</span> <span class="keyword">of</span> <a href="index.html#type-threadID">threadID</a> * <a href="index.html#type-bytecode">bytecode</a> * <a href="index.html#type-stack">stack</a></code></td></tr></table></dt><dd><p>Note each thread has a local stack, but heap is global</p></dd></dl><dl><dt class="spec type" id="type-thread_pool"><a href="#type-thread_pool" class="anchor"></a><code><span class="keyword">type</span> thread_pool</code><code> = <span><a href="index.html#type-thread">thread</a> list</span></code></dt></dl><dl><dt class="spec value" id="val-init_thread_pool"><a href="#val-init_thread_pool" class="anchor"></a><code><span class="keyword">val</span> init_thread_pool : <a href="index.html#type-bytecode">bytecode</a> <span>&#45;&gt;</span> <a href="index.html#type-stack">stack</a> <span>&#45;&gt;</span> <a href="index.html#type-thread_pool">thread_pool</a></code></dt><dd><p>Arguments = the instructions and the initial stack of a compiled program - initialises a thread pool in order to begin execution</p></dd></dl><dl><dt class="spec value" id="val-create_obj"><a href="#val-create_obj" class="anchor"></a><code><span class="keyword">val</span> create_obj : <a href="index.html#type-heap">heap</a> <span>&#45;&gt;</span> <a href="../../ast/Ast/Ast_types/Class_name/index.html#type-t">Ast.Ast_types.Class_name.t</a> <span>&#45;&gt;</span> <a href="index.html#type-address">address</a> * <a href="index.html#type-heap">heap</a></code></dt><dd><p>This returns the address of the new object as well as the updated heap</p></dd></dl><aside><p>Helper methods for stack</p></aside><dl><dt class="spec value" id="val-get_free_var_bindings"><a href="#val-get_free_var_bindings" class="anchor"></a><code><span class="keyword">val</span> get_free_var_bindings : <a href="index.html#type-bytecode">bytecode</a> <span>&#45;&gt;</span> <a href="index.html#type-stack">stack</a> <span>&#45;&gt;</span> <a href="index.html#type-env">env</a></code></dt><dt class="spec value" id="val-stack_lookup"><a href="#val-stack_lookup" class="anchor"></a><code><span class="keyword">val</span> stack_lookup : <a href="index.html#type-stack">stack</a> <span>&#45;&gt;</span> <a href="../../ast/Ast/Ast_types/Var_name/index.html#type-t">Ast.Ast_types.Var_name.t</a> <span>&#45;&gt;</span> <span><a href="index.html#type-value">value</a> Core.Or_error.t</span></code></dt><dt class="spec value" id="val-stack_set_var"><a href="#val-stack_set_var" class="anchor"></a><code><span class="keyword">val</span> stack_set_var : <a href="index.html#type-stack">stack</a> <span>&#45;&gt;</span> <a href="../../ast/Ast/Ast_types/Var_name/index.html#type-t">Ast.Ast_types.Var_name.t</a> <span>&#45;&gt;</span> <a href="index.html#type-value">value</a> <span>&#45;&gt;</span> <a href="index.html#type-stack">stack</a></code></dt><dt class="spec value" id="val-heap_lookup_field"><a href="#val-heap_lookup_field" class="anchor"></a><code><span class="keyword">val</span> heap_lookup_field : <a href="index.html#type-heap">heap</a> <span>&#45;&gt;</span> <a href="index.html#type-address">address</a> <span>&#45;&gt;</span> <a href="../../ast/Ast/Ast_types/Field_name/index.html#type-t">Ast.Ast_types.Field_name.t</a> <span>&#45;&gt;</span> <span><a href="index.html#type-value">value</a> Core.Or_error.t</span></code></dt><dd><p>Helper methods for the heap</p></dd></dl><dl><dt class="spec value" id="val-heap_set_field"><a href="#val-heap_set_field" class="anchor"></a><code><span class="keyword">val</span> heap_set_field : <a href="index.html#type-heap">heap</a> <span>&#45;&gt;</span> <a href="index.html#type-address">address</a> <span>&#45;&gt;</span> <a href="../../ast/Ast/Ast_types/Field_name/index.html#type-t">Ast.Ast_types.Field_name.t</a> <span>&#45;&gt;</span> <a href="index.html#type-value">value</a> <span>&#45;&gt;</span> <span><a href="index.html#type-heap">heap</a> Core.Or_error.t</span></code></dt></dl><aside><p>Helper methods for threads</p></aside><dl><dt class="spec value" id="val-spawn_thread"><a href="#val-spawn_thread" class="anchor"></a><code><span class="keyword">val</span> spawn_thread : <a href="index.html#type-thread_pool">thread_pool</a> <span>&#45;&gt;</span> <a href="index.html#type-bytecode">bytecode</a> <span>&#45;&gt;</span> <a href="index.html#type-stack">stack</a> <span>&#45;&gt;</span> <a href="index.html#type-threadID">threadID</a> * <a href="index.html#type-thread_pool">thread_pool</a></code></dt><dt class="spec value" id="val-get_thread"><a href="#val-get_thread" class="anchor"></a><code><span class="keyword">val</span> get_thread : <a href="index.html#type-threadID">threadID</a> <span>&#45;&gt;</span> <a href="index.html#type-thread_pool">thread_pool</a> <span>&#45;&gt;</span> <span><a href="index.html#type-thread">thread</a> Core.Or_error.t</span></code></dt><dt class="spec value" id="val-remove_thread"><a href="#val-remove_thread" class="anchor"></a><code><span class="keyword">val</span> remove_thread : <a href="index.html#type-threadID">threadID</a> <span>&#45;&gt;</span> <a href="index.html#type-thread_pool">thread_pool</a> <span>&#45;&gt;</span> <a href="index.html#type-thread_pool">thread_pool</a></code></dt><dt class="spec value" id="val-replace_thread"><a href="#val-replace_thread" class="anchor"></a><code><span class="keyword">val</span> replace_thread : <a href="index.html#type-thread">thread</a> <span>&#45;&gt;</span> <a href="index.html#type-thread_pool">thread_pool</a> <span>&#45;&gt;</span> <a href="index.html#type-thread_pool">thread_pool</a></code></dt></dl></div></body></html>